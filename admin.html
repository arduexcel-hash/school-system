<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Û•Ú•ÛÙˆØ¨Û•Ø±Ø§ÛŒÛ•ØªÛŒ | Smart School Admin</title>
    
    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f8fafc; margin: 0; color: #334155; }
        
        header { background: var(--primary); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; font-size: 0.9rem; }
        .btn-blue { background: var(--accent); }
        .btn-orange { background: var(--warning); }
        .btn-green { background: var(--success); }
        .btn-action { padding: 5px 10px; font-size: 0.8rem; margin: 2px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; color: #475569; font-weight: bold; }

        /* Modal - Ù¾Û•Ù†Ø¬Û•Ø±Û•ÛŒ Ø¬Û†ÛŒÙ†Ø¨ÙˆÙˆÙ†ÛŒ Ø¨Û•Ø®ÛÙˆÚ©Û•Ø±Ø§Ù† */
        #parentsModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; backdrop-filter: blur(4px); }
        .modal-content { background:white; width:95%; max-width:900px; margin:40px auto; padding:25px; border-radius:15px; max-height:85vh; overflow-y:auto; position: relative; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-block; }
        .on { background: #dcfce7; color: #166534; }
        .off { background: #fee2e2; color: #991b1b; }

        .date-input { padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; outline: none; font-family: inherit; }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #eee; width: 100%; }
            header { display: none; }
        }
    </style>
</head>
<body>

<header class="no-print">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5rem;">ğŸ›¡ï¸</span>
        <h2 style="margin: 0;">Ú©Û†Ù†ØªÚ•Û†ÚµÛŒ Ø¨Û•Ú•ÛÙˆØ¨Û•Ø±</h2>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-blue" onclick="openParentsModal()">ğŸ“± Ø¬Û†ÛŒÙ†Ø¨ÙˆÙˆÙ†ÛŒ Ø¨Û•Ø®ÛÙˆÚ©Û•Ø±Ø§Ù†</button>
        <button class="btn btn-orange" onclick="checkLongAbsence()">âš ï¸ ØºØ§ÛŒØ¨ÛŒ Ø³Û•Ø±Ùˆ Ù¦ Ú•Û†Ú˜</button>
    </div>
</header>

<div class="container">
    <div class="card no-print" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div>
            <label><b>Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±ÙˆØ§Ø±:</b> </label>
            <input type="date" id="selectedDate" class="date-input" onchange="loadAttendance()">
        </div>
        <button class="btn btn-green" onclick="window.print()">ğŸ–¨ï¸ Ù¾Ø±Ù†ØªÛŒ Ú•Ø§Ù¾Û†Ø±Øª</button>
    </div>

    <div class="card">
        <h3 id="reportTitle" style="margin-top: 0; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">ğŸ“Š Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ†ÛŒ Ú•Û†Ú˜</h3>
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th>Ù†Ø§ÙˆÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒ</th>
                    <th>Ù¾Û†Ù„</th>
                    <th>Ø¯Û†Ø®</th>
                    <th>Ú©Ø§ØªÛŒ Ù‡Ø§ØªÙ†</th>
                    <th class="no-print">Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</th>
                </tr>
            </thead>
            <tbody id="attendanceBody">
                </tbody>
        </table>
    </div>
</div>

<div id="parentsModal" class="no-print">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin:0;">ğŸ“± Ø¯Û†Ø®ÛŒ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¨Û•Ø®ÛÙˆÚ©Û•Ø±Ø§Ù† (Real-time)</h3>
            <button onclick="closeParentsModal()" style="cursor:pointer; border:none; background:#eee; padding:5px 12px; border-radius:50%; font-size:1.2rem;">&times;</button>
        </div>
        <div id="stats" style="margin-bottom:15px; padding:10px; background:#f1f5f9; border-radius:8px; font-weight:bold; color:var(--accent);">Ø¨Ø§Ø±Ø¯Û•Ú©Ø±ÛØª...</div>
        <table>
            <thead>
                <tr>
                    <th>Ù†Ø§ÙˆÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒ</th>
                    <th>Ø¦Ø§ÛŒØ¯ÛŒ Ú©Ø§Ø±Øª</th>
                    <th>Ø¯Û†Ø®ÛŒ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ</th>
                    <th>Ú©Û†ØªØ§ Ø¨ÛŒÙ†ÛŒÙ†</th>
                </tr>
            </thead>
            <tbody id="parentsTableBody"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCNE5SrgyfTV6_6fieRCLaKPyAGk0ox-FM", 
        authDomain: "school-system-4d4da.firebaseapp.com", 
        projectId: "school-system-4d4da", 
        appId: "1:554610137178:web:4b549d67471722030da063" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ Ø¦Û•Ù…Ú•Û†
    document.getElementById('selectedDate').valueAsDate = new Date();

    // Ù¡. Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ù„ÛŒØ³ØªÛŒ Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ†
    async function loadAttendance() {
        const date = document.getElementById('selectedDate').value;
        document.getElementById('reportTitle').innerText = `ğŸ“Š Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú•Û†Ú˜ÛŒ (${date})`;
        const tbody = document.getElementById("attendanceBody");
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•...</td></tr>";

        try {
            const allStudentsSnap = await getDocs(collection(db, "students"));
            const presentSnap = await getDocs(collection(db, "Attendance", date, "Present"));
            const absentSnap = await getDocs(collection(db, "Attendance", date, "Absent"));

            // Ø¦Û•Ú¯Û•Ø± Ú•Û†Ú˜Û•Ú©Û• Ù¾Ø´ÙˆÙˆ Ø¨ÙˆÙˆ ÛŒØ§Ù† Ø¯Ø§ØªØ§ÛŒ ØªÛØ¯Ø§ Ù†Û•Ø¨ÙˆÙˆ
            if (presentSnap.empty && absentSnap.empty) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:#94a3b8; padding:40px;'>Ù„Û•Ù… Ø¨Û•Ø±ÙˆØ§Ø±Û•Ø¯Ø§ Ù‡ÛŒÚ† Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú© ØªÛ†Ù…Ø§Ø± Ù†Û•Ú©Ø±Ø§ÙˆÛ• (Ù¾Ø´ÙˆÙˆ ÛŒØ§Ù† Ù†Û•Ø¨ÙˆÙˆÙ†ÛŒ Ø¯Û•ÙˆØ§Ù…)</td></tr>";
                return;
            }

            const presentList = {}; presentSnap.forEach(d => presentList[d.id] = d.data());
            const absentList = {}; absentSnap.forEach(d => absentList[d.id] = d.data());

            tbody.innerHTML = "";
            allStudentsSnap.forEach(stDoc => {
                const st = stDoc.data();
                const id = st.cardID;
                let status = "Ù†Û•Ù‡Ø§ØªÙˆÙˆ";
                let time = "---";
                let rowColor = "#ef4444"; // Ø³ÙˆÙˆØ± Ø¨Û† ØºØ§ÛŒØ¨

                if (presentList[id]) {
                    status = presentList[id].status || "Ø¦Ø§Ù…Ø§Ø¯Û•";
                    time = presentList[id].time || "Ù†Ø§Ø¯ÛŒØ§Ø±";
                    rowColor = status === "Ø¦Ø§Ù…Ø§Ø¯Û•" ? "#10b981" : "#f59e0b"; // Ø³Û•ÙˆØ² Ø¨Û† Ø¦Ø§Ù…Ø§Ø¯Û•ØŒ Ù¾Ø±ØªÛ•Ù‚Ø§ÚµÛŒ Ø¨Û† Ù…Û†ÚµÛ•Øª
                } else if (absentList[id]) {
                    status = "ØºØ§ÛŒØ¨";
                    time = "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§Ùˆ";
                } else {
                    status = "Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†";
                    rowColor = "#94a3b8";
                }

                tbody.innerHTML += `
                    <tr style="color: ${rowColor};">
                        <td style="color:#1e293b; font-weight:500;">${st.name}</td>
                        <td>${st.class || "--"}</td>
                        <td><b>${status}</b></td>
                        <td dir="ltr" style="text-align:right;">${time}</td>
                        <td class="no-print">
                            <button class="btn btn-blue btn-action" onclick="updateStatus('${id}', 'Ù…Û†ÚµÛ•Øª')">Ù…Û†ÚµÛ•Øª</button>
                            <button class="btn btn-orange btn-action" onclick="updateStatus('${id}', 'Ø¨ÛŒØ±Ú†ÙˆÙˆ')">Ø¨ÛŒØ±Ú†ÙˆÙˆ</button>
                        </td>
                    </tr>`;
            });
        } catch (error) {
            console.error(error);
            tbody.innerHTML = "<tr><td colspan='5'>Ù‡Û•ÚµÛ•ÛŒÛ•Ú© Ù„Û• ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ø¯Ø§ØªØ§ Ú•ÙˆÙˆÛŒØ¯Ø§</td></tr>";
        }
    }

    // Ù¢. Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¯Û†Ø® Ø¨Û† Ù…Û†ÚµÛ•Øª ÛŒØ§Ù† Ø¨ÛŒØ±Ú†ÙˆÙˆ
    window.updateStatus = async (id, newStatus) => {
        const date = document.getElementById('selectedDate').value;
        const q = query(collection(db, "students"), where("cardID", "==", id));
        const snap = await getDocs(q);
        if (snap.empty) return;
        const stData = snap.docs[0].data();

        await setDoc(doc(db, "Attendance", date, "Present", id), {
            name: stData.name,
            status: newStatus,
            time: new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' })
        });
        loadAttendance();
    };

    // Ù£. Ù…Û†Ø¯Ø§ÚµÛŒ Ø¬Û†ÛŒÙ†Ø¨ÙˆÙˆÙ†ÛŒ Ø¨Û•Ø®ÛÙˆÚ©Û•Ø±Ø§Ù†
    window.openParentsModal = async function() {
        document.getElementById('parentsModal').style.display = 'block';
        const tbody = document.getElementById("parentsTableBody");
        const stuSnap = await getDocs(collection(db, "students"));
        const students = [];
        stuSnap.forEach(doc => students.push(doc.data()));

        onSnapshot(collection(db, "ConnectedParents"), (snapshot) => {
            const connectedData = {};
            snapshot.forEach(doc => connectedData[doc.id] = doc.data());
            
            tbody.innerHTML = "";
            let onlineCount = 0;
            students.forEach(s => {
                const conn = connectedData[s.cardID];
                const isOnline = conn && conn.status === "Online";
                if (isOnline) onlineCount++;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${s.name}</td>
                        <td><code>${s.cardID}</code></td>
                        <td>
                            <span class="badge ${isOnline ? 'on' : 'off'}">
                                ${conn ? (isOnline ? 'â— Ø¦Û†Ù†Ù„Ø§ÛŒÙ†' : 'â—‹ Ø¦Û†ÙÙ„Ø§ÛŒÙ†') : 'âŒ Ø¬Û†ÛŒÙ† Ù†ÛŒÛŒÛ•'}
                            </span>
                        </td>
                        <td style="font-size:0.85rem; color:#64748b;">${conn ? conn.lastSeen : '---'}</td>
                    </tr>`;
            });
            document.getElementById('stats').innerText = `Ú©Û†ÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù†: ${students.length} | Ø¬Û†ÛŒÙ†Ø¨ÙˆÙˆ: ${snapshot.size} | Ø¦ÛØ³ØªØ§ Ø¦Û†Ù†Ù„Ø§ÛŒÙ†: ${onlineCount}`;
        });
    }

    window.closeParentsModal = () => {
        document.getElementById('parentsModal').style.display = 'none';
    };

    // Ù¤. Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ ØºØ§ÛŒØ¨ÛŒ Ø³Û•Ø±Ùˆ Ù¦ Ú•Û†Ú˜
    window.checkLongAbsence = async () => {
        alert("Ø³ÛŒØ³ØªÛ•Ù…Û•Ú©Û• Ø¯Û•Ø³ØªÛŒ Ú©Ø±Ø¯ Ø¨Û• Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ù…ÛÚ˜ÙˆÙˆÛŒ ØºØ§ÛŒØ¨Ø§Øª...");
        const studentsSnap = await getDocs(collection(db, "students"));
        const attendanceRef = collection(db, "Attendance");
        const daysSnap = await getDocs(attendanceRef);
        
        let results = [];
        for (const stDoc of studentsSnap.docs) {
            const st = stDoc.data();
            let count = 0;
            for (const dayDoc of daysSnap.docs) {
                const absDoc = await getDoc(doc(db, "Attendance", dayDoc.id, "Absent", st.cardID));
                if (absDoc.exists()) count++;
            }
            if (count > 6) results.push(`${st.name}: ${count} Ú•Û†Ú˜`);
        }

        if (results.length > 0) {
            alert("Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù†ÛŒ ØºØ§ÛŒØ¨ (Ø³Û•Ø±Ùˆ Ù¦ Ú•Û†Ú˜):\n\n" + results.join("\n"));
        } else {
            alert("Ù‡ÛŒÚ† Ù‚ÙˆØªØ§Ø¨ÛŒÛŒÛ•Ú© Ø³Û•Ø±Ùˆ Ù¦ Ú•Û†Ú˜ ØºØ§ÛŒØ¨ Ù†ÛŒÛŒÛ•.");
        }
    }

    // Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ ÙˆÛØ¨Û•Ú©Û•
    window.loadAttendance = loadAttendance;
    loadAttendance();

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Û†Ø±ØªØ§ÚµÛŒ Ø¨Û•Ø®ÛÙˆÚ©Û•Ø±Ø§Ù† | Smart School</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/2563eb/ffffff?text=School">

    <style>
        :root { --bg: #f1f5f9; --card: #ffffff; --primary: #2563eb; --success: #10b981; --danger: #ef4444; --warning: #eab308; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        
        .card { background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 380px; text-align: center; border: 1px solid #e2e8f0; position: relative; }
        
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 10px; text-align: center; font-size: 1rem; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1rem; }

        .status-box { display: none; margin-top: 20px; padding: 25px; border-radius: 15px; border: 2px solid transparent; animation: fadeIn 0.5s ease; }
        .present { background: #dcfce7; color: #166534; border-color: var(--success); }
        .absent { background: #fee2e2; color: #991b1b; border-color: var(--danger); }
        .waiting { background: #fef9c3; color: #854d0e; border-color: var(--warning); }
        
        /* Ø³ØªØ§ÛŒÙ„ÛŒ Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù‡Ø§ÙˆØ´ÛÙˆÛ•ÛŒ Ù†Ø§Ú¤Ú©Û•ÛŒØ´Ù† */
        .push-notif { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 15px; z-index: 9999; transition: top 0.5s ease; border-right: 5px solid var(--danger); }
        .push-notif.show { top: 20px; }

        .install-btn { display: none; background: #1e293b; margin-top: 10px; font-size: 0.8rem; }
        .logout { font-size: 0.85rem; color: #94a3b8; cursor: pointer; margin-top: 25px; text-decoration: underline; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="customNotif" class="push-notif">
        <div style="background:var(--danger); color:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">âš ï¸</div>
        <div style="text-align:right;">
            <b style="display:block; font-size:0.9rem;">Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±ÛŒ Ù†ÙˆÛ</b>
            <span id="notifMsg" style="font-size:0.8rem; color:#64748b;">Ù…Ù†Ø¯Ø§ÚµÛ•Ú©Û•Øª Ø¨Û• ØºØ§ÛŒØ¨ ØªÛ†Ù…Ø§Ø± Ú©Ø±Ø§</span>
        </div>
    </div>

    <div id="loginArea" class="card">
        <h2>Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª</h2>
        <p>Ø¦Ø§ÛŒØ¯ÛŒ Ú©Ø§Ø±ØªÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•</p>
        <input type="text" id="studentID" placeholder="Card ID">
        <button onclick="login()">Ø¯Ø§Ø®ÚµØ¨ÙˆÙˆÙ†</button>
        <button id="installBtn" class="install-btn" onclick="installPWA()">ğŸ“¥ Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù†ÛŒ Ø¦Û•Ù¾ÛŒ Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•</button>
    </div>

    <div id="statusArea" class="card" style="display: none;">
        <h2 id="stName">Ù†Ø§Ùˆ</h2>
        <p id="stClass">Ù¾Û†Ù„</p>
        <div id="statusIndicator" class="status-box">
            <span id="statusText" style="font-size: 1.4rem; font-weight: bold;">--</span>
            <span id="arrivalTime" style="display:block; margin-top:10px;">--</span>
        </div>
        <div class="logout" onclick="logout()">Ú¯Û†Ú•ÛŒÙ†ÛŒ Ø¦Ø§ÛŒØ¯ÛŒ ğŸ”ƒ</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, onSnapshot, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCNE5SrgyfTV6_6fieRCLaKPyAGk0ox-FM", 
        authDomain: "school-system-4d4da.firebaseapp.com", 
        projectId: "school-system-4d4da", 
        appId: "1:554610137178:web:4b549d67471722030da063" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let today = new Date().toISOString().split('T')[0];
    let lastStatus = "";

    // Ø¯Ø§ÙˆØ§Ú©Ø±Ø¯Ù†ÛŒ Ú•ÛÚ¯Û•Ù¾ÛØ¯Ø§Ù†ÛŒ Ù†Û†ØªÙÛŒÚ©Û•ÛŒØ´Ù†
    if ("Notification" in window) {
        Notification.requestPermission();
    }

    const savedID = localStorage.getItem('parent_student_id');
    if (savedID) showStatus(savedID);

    window.login = async function() {
        const idInput = document.getElementById('studentID').value.trim().toUpperCase();
        if (!idInput) return alert("Ø¦Ø§ÛŒØ¯ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•");
        const q = query(collection(db, "students"), where("cardID", "==", idInput));
        const snap = await getDocs(q);
        if (!snap.empty) {
            localStorage.setItem('parent_student_id', idInput);
            showStatus(idInput);
        } else { alert("Ø¦Û•Ù… Ø¦Ø§ÛŒØ¯ÛŒÛŒÛ• Ù†ÛŒÛŒÛ•!"); }
    };

    async function showStatus(id) {
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('statusArea').style.display = 'block';

        const q = query(collection(db, "students"), where("cardID", "==", id));
        const snap = await getDocs(q);
        const stData = snap.docs[0].data();
        document.getElementById('stName').innerText = stData.name;
        document.getElementById('stClass').innerText = "Ù¾Û†Ù„ÛŒ: " + (stData.class || "--");

        // ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø¦Û†Ù†Ù„Ø§ÛŒÙ† Ø¨ÙˆÙˆÙ†
        setDoc(doc(db, "ConnectedParents", id), {
            name: stData.name, status: "Online", lastSeen: new Date().toLocaleString()
        }, { merge: true });

        // Ú†Ø§ÙˆÚ•ÛÚ©Ø±Ø¯Ù†ÛŒ Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ Ø¯Û†Ø®ÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒ
        onSnapshot(doc(db, "Attendance", today, "Present", id), (pSnap) => {
            if (pSnap.exists()) { updateUI("present", "Ú¯Û•ÛŒØ´ØªÙˆÙˆÛ• âœ…", "Ú©Ø§Øª: " + pSnap.data().time); }
            else {
                onSnapshot(doc(db, "Attendance", today, "Absent", id), (aSnap) => {
                    if (aSnap.exists()) { updateUI("absent", "ØºØ§ÛŒØ¨Û• âŒ", "Ù†Û•Ù‡Ø§ØªÙˆÙˆÛ• Ø¨Û† Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•"); }
                    else { updateUI("waiting", "Ù‡ÛØ´ØªØ§ Ù†Û•Ú¯Û•ÛŒØ´ØªÙˆÙˆÛ• â³", "Ù„Û• Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒØ¯Ø§ÛŒÙ†..."); }
                });
            }
        });
    }

    function updateUI(cls, txt, time) {
        const box = document.getElementById('statusIndicator');
        box.style.display = 'block';
        box.className = "status-box " + cls;
        document.getElementById('statusText').innerText = txt;
        document.getElementById('arrivalTime').innerText = time;

        // Ø¦Û•Ú¯Û•Ø± ØºØ§ÛŒØ¨ Ø¨ÙˆÙˆ Ùˆ Ù¾ÛØ´ØªØ± ØºØ§ÛŒØ¨ Ù†Û•Ø¨ÙˆÙˆØŒ Ù†Û†ØªÙÛŒÚ©Û•ÛŒØ´Ù† Ø¨Ù†ÛØ±Û•
        if (cls === "absent" && lastStatus !== "absent") {
            triggerNotification("Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±ÛŒ ØºØ§ÛŒØ¨ Ø¨ÙˆÙˆÙ†", "Ù…Ù†Ø¯Ø§ÚµÛ•Ú©Û•Øª Ø¦Û•Ù…Ú•Û† Ø¨Û• ØºØ§ÛŒØ¨ ØªÛ†Ù…Ø§Ø± Ú©Ø±Ø§");
        }
        lastStatus = cls;
    }

    function triggerNotification(title, msg) {
        // Ù†Û†ØªÙÛŒÚ©Û•ÛŒØ´Ù†ÛŒ Ù†Ø§Ùˆ ÙˆÛØ¨
        const notif = document.getElementById('customNotif');
        document.getElementById('notifMsg').innerText = msg;
        notif.classList.add('show');
        setTimeout(() => notif.classList.remove('show'), 5000);

        // Ù†Û†ØªÙÛŒÚ©Û•ÛŒØ´Ù†ÛŒ Ù…Û†Ø¨Ø§ÛŒÙ„ (Ø¨Û† Ú©Ø§ØªÛÚ© Ú©Û• ÙˆÛØ¨Û•Ú©Û• Ù„Û• Ø¨Ø§Ú©Ú¯Ø±Ø§ÙˆÙ†Ø¯Û•)
        if (Notification.permission === "granted") {
            new Notification(title, { body: msg, icon: "https://via.placeholder.com/128/ef4444/ffffff?text=!" });
        }
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }

    window.logout = function() {
        localStorage.removeItem('parent_student_id');
        location.reload();
    };
</script>

<script>
    // Ú©Û†Ø¯ÛŒ Add to Home Screen
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installBtn').style.display = 'block';
    });

    async function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt = null;
        }
    }
</script>
</body>
</html>

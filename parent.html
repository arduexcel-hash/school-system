<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Û†Ø±ØªØ§ÚµÛŒ Ø¨Û•Ø®ÛÙˆÚ©Û•Ø±Ø§Ù†</title>
    <style>
        :root { --bg: #f1f5f9; --card: #ffffff; --primary: #2563eb; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 380px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 10px; text-align: center; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; }
        .status-box { display: none; margin-top: 20px; padding: 20px; border-radius: 15px; border: 2px solid transparent; }
        .present { background: #dcfce7; color: #166534; border-color: var(--success); }
        .absent { background: #fee2e2; color: #991b1b; border-color: var(--danger); }
        .waiting { background: #fef9c3; color: #854d0e; border-color: #eab308; }
        .logout { font-size: 0.8rem; color: #64748b; cursor: pointer; margin-top: 20px; text-decoration: underline; }
    </style>
</head>
<body>

<div id="loginArea" class="card">
    <h2>Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</h2>
    <p>Ø¦Ø§ÛŒØ¯ÛŒ Ú©Ø§Ø±ØªÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•</p>
    <input type="text" id="studentID" placeholder="Card ID">
    <button onclick="login()">Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
</div>

<div id="statusArea" class="card" style="display: none;">
    <h2 id="stName">--</h2>
    <p id="stClass">--</p>
    <div id="statusIndicator" class="status-box">
        <span id="statusText" style="font-size: 1.3rem; font-weight: bold;">--</span><br>
        <span id="arrivalTime">--</span>
    </div>
    <div class="logout" onclick="logout()">Ú¯Û†Ú•ÛŒÙ†ÛŒ Ø¦Ø§ÛŒØ¯ÛŒ ğŸ”ƒ</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCNE5SrgyfTV6_6fieRCLaKPyAGk0ox-FM", 
        authDomain: "school-system-4d4da.firebaseapp.com", 
        projectId: "school-system-4d4da", 
        appId: "1:554610137178:web:4b549d67471722030da063" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let today = new Date().toISOString().split('T')[0];

    // Ù¡. Ù¾Ø´Ú©Ù†ÛŒÙ† Ø¦Û•Ú¯Û•Ø± Ù¾ÛØ´ØªØ± Ø¯Ø§Ø®ÚµØ¨ÙˆÙˆÛ•
    const savedID = localStorage.getItem('parent_student_id');
    if (savedID) showStatus(savedID);

    window.login = async function() {
        const id = document.getElementById('studentID').value.trim().toUpperCase();
        if (!id) return alert("ØªÚ©Ø§ÛŒÛ• Ø¦Ø§ÛŒØ¯ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•");

        // Ú¯Û•Ú•Ø§Ù† Ø¨Û•Ø¯ÙˆØ§ÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒ Ø¨Û•Ù¾ÛÛŒ cardID Ù†Û•Ú© Ø¨Û•Ù¾ÛÛŒ Ù†Ø§ÙˆÛŒ Ø¯Û†Ú©ÛŒÙˆÙ…ÛÙ†Øª
        const q = query(collection(db, "students"), where("cardID", "==", id));
        const snap = await getDocs(q);

        if (!snap.empty) {
            localStorage.setItem('parent_student_id', id);
            showStatus(id);
        } else {
            alert("Ø¦Û•Ù… Ø¦Ø§ÛŒØ¯ÛŒÛŒÛ• Ù„Û• Ø³ÛŒØ³ØªÛ•Ù… Ù†ÛŒÛŒÛ•!");
        }
    }

    async function showStatus(id) {
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('statusArea').style.display = 'block';

        // Ù‡ÛÙ†Ø§Ù†ÛŒ Ù†Ø§ÙˆÛŒ Ù‚ÙˆØªØ§Ø¨ÛŒ
        const q = query(collection(db, "students"), where("cardID", "==", id));
        const snap = await getDocs(q);
        const stData = snap.docs[0].data();
        document.getElementById('stName').innerText = stData.name;
        document.getElementById('stClass').innerText = "Ù¾Û†Ù„ÛŒ: " + (stData.class || "--");

        // Ú†Ø§ÙˆØ¯ÛØ±ÛŒ Ú©Ø±Ø¯Ù†ÛŒ Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ†ÛŒ Ø¦Û•Ù…Ú•Û† (Real-time)
        // Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ø¨Û•Ø´ÛŒ Present
        onSnapshot(doc(db, "Attendance", today, "Present", id), (pSnap) => {
            if (pSnap.exists()) {
                updateUI("present", "Ú¯Û•ÛŒØ´ØªÙˆÙˆÛ• âœ…", "Ú©Ø§Øª: " + pSnap.data().time);
            } else {
                // Ø¦Û•Ú¯Û•Ø± Ø¦Ø§Ù…Ø§Ø¯Û• Ù†Û•Ø¨ÙˆÙˆØŒ Ù¾Ø´Ú©Ù†ÛŒÙ† Ø¨Û† Absent
                onSnapshot(doc(db, "Attendance", today, "Absent", id), (aSnap) => {
                    if (aSnap.exists()) {
                        updateUI("absent", "ØºØ§ÛŒØ¨Û• âŒ", "Ù†Û•Ù‡Ø§ØªÙˆÙˆÛ• Ø¨Û† Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•");
                    } else {
                        updateUI("waiting", "Ù‡ÛØ´ØªØ§ Ù†Û•Ú¯Û•ÛŒØ´ØªÙˆÙˆÛ• â³", "Ù„Û• Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒØ¯Ø§ÛŒÙ†...");
                    }
                });
            }
        });
    }

    function updateUI(cls, txt, time) {
        const box = document.getElementById('statusIndicator');
        box.style.display = 'block';
        box.className = "status-box " + cls;
        document.getElementById('statusText').innerText = txt;
        document.getElementById('arrivalTime').innerText = time;
    }

    window.logout = function() {
        localStorage.removeItem('parent_student_id');
        location.reload();
    }
</script>
</body>
</html>
